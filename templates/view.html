{% extends "base.html" %}

{% block content %}
<div class="container px-2">
    <div class="card mb-3">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
                <h2 class="card-title mb-0">{{ plant.name }} #{{ plant.number }}</h2>                
            </div>
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                    <p class="text-muted mb-0">Owner: {{ plant.user.username }}</p>
                </div>
                {% set first_photo = plant.facts|selectattr('photo_path')|first %}
                {% if first_photo %}
                <div>
                    <img src="/static/{{ first_photo.photo_path }}" alt="{{ first_photo.label }}"
                        class="img-fluid rounded" style="max-height: 100px; cursor: pointer;"
                        data-plant-name="{{ plant.name }}" data-plant-number="{{ plant.id }}"
                        data-photo-date="{{ first_photo.created_at.strftime('%Y-%m-%d') }}">
                </div>
                {% endif %}
            </div>
            <div class="d-grid gap-2 d-md-flex justify-content-md-start mb-3">
                <a href="{{ url_for('edit_plant', id=plant.id) }}?from=view" class="btn btn-outline-secondary btn-sm">Edit Plant</a>
                <button id="toggle-edit" class="btn btn-outline-secondary btn-sm">Edit Details</button>
                <a href="/plant/{{ plant.id }}/facts/add" class="btn btn-outline-primary btn-sm">
                    Add New Detail
                </a>
            </div>
        </div>
    </div>

    <div id="plant-facts-container" class="mb-3" data-plant-id="{{ plant.id }}">
        {% if plant.facts %}
            {% for fact in plant.facts|sort(attribute='position') %}
            <div class="card mb-3 fact-item" data-id="{{ fact.id }}">
                <div class="card-body p-3">
                    <div>
                        <h5 class="mb-2">{{ fact.label }}</h5>

                        {% if fact.value_type == 'photo' %}
                        <div class="text-center mb-2">
                            <img src="/static/{{ fact.photo_path }}" class="img-fluid"
                                style="max-height: 200px; cursor: pointer;" data-plant-name="{{ plant.name }}"
                                data-plant-number="{{ plant.id }}"
                                data-photo-date="{{ fact.created_at.strftime('%Y-%m-%d') }}">
                        </div>
                        {% else %}
                        <p class="mb-2">{{ fact.value }}</p>
                        {% endif %}

                        <small class="text-muted d-block">
                            Type: {{ fact.value_type }} |
                            Added: {{ fact.created_at.strftime('%Y-%m-%d') }} |
                            Updated: {{ fact.updated_at.strftime('%Y-%m-%d') }}
                        </small>

                        <div class="edit-controls d-none d-grid gap-2 d-md-flex justify-content-md-between align-items-center mt-3">
                            <div class="d-grid gap-2 d-md-flex">
                                <button class="btn btn-sm btn-outline-secondary move-up">↑ Move Up</button>
                                <button class="btn btn-sm btn-outline-secondary move-down">↓ Move Down</button>
                            </div>
                            <button class="btn btn-sm btn-outline-danger delete-fact">× Delete</button>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <p class="text-muted">No facts recorded yet</p>
        {% endif %}
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const toggleEdit = document.getElementById('toggle-edit');
        const editControls = document.querySelectorAll('.edit-controls.d-none');
        
        toggleEdit.addEventListener('click', function() {
            editControls.forEach(control => {
                control.classList.toggle('d-none');
            });
            this.textContent = this.textContent.includes('Edit') ?
                'Cancel Editing' : 'Edit Details';
        });

        // Fact reordering and deletion
        document.addEventListener('click', async function(e) {
            if (e.target.classList.contains('move-up') ||
                e.target.classList.contains('move-down') ||
                e.target.classList.contains('delete-fact')) {
                
                const factItem = e.target.closest('.fact-item');
                if (!factItem) return;

                const factId = factItem.dataset.id;
                const plantId = document.getElementById('plant-facts-container').dataset.plantId;

                if (e.target.classList.contains('move-up')) {
                    try {
                        const response = await fetch(`/plants/${plantId}/facts/${factId}/reorder`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ direction: 'up' })
                        });

                        if (response.ok) {
                            const prevItem = factItem.previousElementSibling;
                            if (prevItem && prevItem.classList.contains('fact-item')) {
                                factItem.parentNode.insertBefore(factItem, prevItem);
                            }
                        }
                    } catch (error) {
                        console.error('Error moving fact up:', error);
                    }
                }
                else if (e.target.classList.contains('move-down')) {
                    try {
                        const response = await fetch(`/plants/${plantId}/facts/${factId}/reorder`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ direction: 'down' })
                        });

                        if (response.ok) {
                            const nextItem = factItem.nextElementSibling;
                            if (nextItem && nextItem.classList.contains('fact-item')) {
                                factItem.parentNode.insertBefore(nextItem, factItem);
                            }
                        }
                    } catch (error) {
                        console.error('Error moving fact down:', error);
                    }
                }
                else if (e.target.classList.contains('delete-fact')) {
                    if (confirm('Are you sure you want to delete this fact?')) {
                        try {
                            const response = await fetch(`/plants/${plantId}/facts/${factId}`, {
                                method: 'DELETE'
                            });

                            if (response.ok) {
                                factItem.remove();
                            }
                        } catch (error) {
                            console.error('Error deleting fact:', error);
                        }
                    }
                }
            }
        });
    });
</script>
{% endblock %}